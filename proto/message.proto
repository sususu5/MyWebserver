syntax = "proto3";
package im;

option cc_enable_arenas = true;

import "auth_service.proto";
import "friend_service.proto";

// CommandType determines which structure the Envelope's oneof unpacks into
enum CommandType {
    CMD_UNKNOWN       = 0;

    // Auth commands
    CMD_REGISTER_REQ  = 1;
    CMD_REGISTER_RES  = 2;
    CMD_LOGIN_REQ     = 3;
    CMD_LOGIN_RES     = 4;
    
    // Friend commands
    CMD_ADD_FRIEND_REQ = 5;
    CMD_ADD_FRIEND_RES = 6;
    CMD_FRIEND_REQ_PUSH = 7;
    CMD_HANDLE_FRIEND_REQ = 8;
    CMD_HANDLE_FRIEND_RES = 9;
    CMD_FRIEND_STATUS_PUSH = 10;
    CMD_GET_FRIEND_LIST_REQ = 11;
    CMD_GET_FRIEND_LIST_RES = 12;

    // Message commands
    CMD_P2P_MSG_REQ   = 50; // P2P message request (Client -> Server)
    CMD_P2P_MSG_PUSH  = 51; // P2P message push (Server -> Client)
    CMD_MSG_ACK       = 52; // Generic message acknowledgment (Server -> Client)
}

// Envelope is the top-level message structure
message Envelope {
    uint64 seq = 1;            // Sequence number for full-duplex link tracing
    CommandType cmd = 2;       // CommandType enum
    int64 timestamp = 3;       // Server timestamp

    oneof payload {
        RegisterReq register_req = 100;
        RegisterResp register_res = 101;
        LoginReq login_req = 102;
        LoginResp login_res = 103;

        AddFriendReq add_friend_req = 200;
        AddFriendResp add_friend_res = 201;
        FriendReqPush friend_req_push = 202;
        HandleFriendReq handle_friend_req = 203;
        HandleFriendResp handle_friend_res = 204;
        FriendStatusPush friend_status_push = 205;
        GetFriendListReq get_friend_list_req = 206;
        GetFriendListResp get_friend_list_res = 207;
    }
}

// ContentType determines how to parse the content field
enum ContentType {
    CONTENT_TEXT    = 0;
}

// Message structure for P2P communication
message P2PMessage {
    string msg_id = 1;
    string sender_id = 2;
    string receiver_id = 3;
    ContentType content_type = 4; 
    bytes content = 5;         
}

// Message acknowledgment structure
message MessageAck {
    string msg_id = 1;
    uint64 ref_seq = 2;
    bool success = 3;
    string error_msg = 4;
}