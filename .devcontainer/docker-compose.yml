services:
  app:
    build:
      context: ..
      dockerfile: .devcontainer/Dockerfile
    volumes:
      - ..:/workspace:cached
      - ssl-certs:/etc/mysql/certs:ro
    command: sleep infinity
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_USER=root
      - MYSQL_PASSWORD=123456
      - MYSQL_DATABASE=testdb

  mysql:
    image: mysql:8.0
    restart: unless-stopped
    entrypoint:
      - /bin/bash
      - -c
      - |
        mkdir -p /certs
        openssl genrsa 2048 > /certs/ca-key.pem
        openssl req -new -x509 -nodes -days 3600 -key /certs/ca-key.pem -out /certs/ca.pem -subj "/CN=MySQL-CA"
        openssl req -newkey rsa:2048 -days 3600 -nodes -keyout /certs/server-key.pem -out /certs/server-req.pem -subj "/CN=mysql"
        openssl rsa -in /certs/server-key.pem -out /certs/server-key.pem
        openssl x509 -req -in /certs/server-req.pem -days 3600 -CA /certs/ca.pem -CAkey /certs/ca-key.pem -set_serial 01 -out /certs/server-cert.pem
        chown -R mysql:mysql /certs
        chmod 600 /certs/*.pem
        chmod 644 /certs/ca.pem /certs/server-cert.pem
        exec /usr/local/bin/docker-entrypoint.sh mysqld --default-authentication-plugin=mysql_native_password --require-secure-transport=ON --ssl-ca=/certs/ca.pem --ssl-cert=/certs/server-cert.pem --ssl-key=/certs/server-key.pem
    environment:
      MYSQL_ROOT_PASSWORD: 123456
      MYSQL_DATABASE: testdb
    ports:
      - "3306:3306"
    volumes:
      - mysql-data:/var/lib/mysql
      - ../sql/schema.sql:/docker-entrypoint-initdb.d/schema.sql:ro
      - ssl-certs:/certs
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p123456"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 30s

volumes:
  mysql-data:
  ssl-certs:

